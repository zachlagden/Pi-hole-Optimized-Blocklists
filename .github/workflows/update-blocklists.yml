name: Update Blocklists

on:
  schedule:
    - cron: '0 0 * * 0'  # Run weekly on Sunday at midnight UTC
  workflow_dispatch:  # Allow manual triggering

jobs:
  update-blocklists:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          lfs: true
          token: ${{ secrets.GH_PAT }}
          fetch-depth: 0

      - name: Download optimizer binary
        run: |
          curl -fsSL -o pihole-optimizer \
            https://github.com/zachlagden/Pi-hole-Blocklist-Optimizer/releases/latest/download/pihole-optimizer-linux-x86_64
          chmod +x pihole-optimizer
          echo "‚úÖ Pi-hole Blocklist Optimizer downloaded"
          ./pihole-optimizer --version

      - name: Run optimizer
        run: |
          echo "üöÄ Starting Pi-hole Blocklist Optimizer..."

          # Run with all features:
          # -t 8: Use 8 concurrent download threads
          # --whitelist-report: Generate detailed whitelist report
          # --prod-dir: Output to production directory
          ./pihole-optimizer \
            -t 8 \
            --whitelist-report \
            --prod-dir pihole_blocklists_prod

          # Verify output
          if [ ! -f "pihole_blocklists_prod/all_domains.txt" ]; then
            echo "‚ùå Error: Optimizer did not produce all_domains.txt"
            exit 1
          fi

          echo "‚úÖ Optimizer completed successfully"
          echo ""
          echo "üìÅ Output files:"
          du -h pihole_blocklists_prod/*.txt | sort -h

          # Show whitelist report if generated
          if [ -f "pihole_blocklists_prod/whitelist_report.txt" ]; then
            echo ""
            echo "üìã Whitelist Report (first 50 lines):"
            head -50 pihole_blocklists_prod/whitelist_report.txt
          fi

      - name: Extract statistics
        id: stats
        run: |
          echo "üìä Extracting statistics..."

          # Count domains in each file (subtract 4 for header lines)
          count_domains() {
            if [ -f "$1" ]; then
              lines=$(wc -l < "$1" | tr -d ' ')
              echo $((lines > 4 ? lines - 4 : 0))
            else
              echo "0"
            fi
          }

          # Count domains
          ALL_DOMAINS=$(count_domains "pihole_blocklists_prod/all_domains.txt")
          AD_DOMAINS=$(count_domains "pihole_blocklists_prod/advertising.txt")
          TRACKING_DOMAINS=$(count_domains "pihole_blocklists_prod/tracking.txt")
          MALICIOUS_DOMAINS=$(count_domains "pihole_blocklists_prod/malicious.txt")
          SUSPICIOUS_DOMAINS=$(count_domains "pihole_blocklists_prod/suspicious.txt")
          COMPREHENSIVE_DOMAINS=$(count_domains "pihole_blocklists_prod/comprehensive.txt")
          NSFW_DOMAINS=$(count_domains "pihole_blocklists_prod/nsfw.txt")

          # Count source lists and whitelist entries
          SOURCE_LISTS=$(grep -v "^#" blocklists.conf | grep -v "^$" | wc -l)
          WHITELIST_ENTRIES=$(grep -v "^#" whitelist.txt | grep -v "^$" | wc -l)

          # Calculate duplicates
          SUM=$(( AD_DOMAINS + TRACKING_DOMAINS + MALICIOUS_DOMAINS + SUSPICIOUS_DOMAINS + COMPREHENSIVE_DOMAINS + NSFW_DOMAINS ))
          DUPLICATES=$(( SUM > ALL_DOMAINS ? SUM - ALL_DOMAINS : 0 ))

          # Format numbers with commas
          format_number() {
            echo "$1" | sed ':a;s/\B[0-9]\{3\}\>/,&/;ta'
          }

          # Set outputs
          echo "total_domains=$ALL_DOMAINS" >> $GITHUB_OUTPUT
          echo "total_domains_formatted=$(format_number $ALL_DOMAINS)" >> $GITHUB_OUTPUT
          echo "duplicates_formatted=$(format_number $DUPLICATES)" >> $GITHUB_OUTPUT
          echo "source_lists=$SOURCE_LISTS" >> $GITHUB_OUTPUT
          echo "whitelist_entries=$WHITELIST_ENTRIES" >> $GITHUB_OUTPUT
          echo "ad_domains=$(format_number $AD_DOMAINS)" >> $GITHUB_OUTPUT
          echo "tracking_domains=$(format_number $TRACKING_DOMAINS)" >> $GITHUB_OUTPUT
          echo "malicious_domains=$(format_number $MALICIOUS_DOMAINS)" >> $GITHUB_OUTPUT
          echo "suspicious_domains=$(format_number $SUSPICIOUS_DOMAINS)" >> $GITHUB_OUTPUT
          echo "comprehensive_domains=$(format_number $COMPREHENSIVE_DOMAINS)" >> $GITHUB_OUTPUT
          echo "nsfw_domains=$(format_number $NSFW_DOMAINS)" >> $GITHUB_OUTPUT
          echo "update_date=$(date +%B\ %d,\ %Y)" >> $GITHUB_OUTPUT

          echo ""
          echo "üìä Statistics:"
          echo "  Total domains: $(format_number $ALL_DOMAINS)"
          echo "  Duplicates removed: $(format_number $DUPLICATES)"
          echo "  Source lists: $SOURCE_LISTS"
          echo "  Whitelist entries: $WHITELIST_ENTRIES"

      - name: Update README
        env:
          TOTAL_DOMAINS: ${{ steps.stats.outputs.total_domains }}
          TOTAL_DOMAINS_FMT: ${{ steps.stats.outputs.total_domains_formatted }}
          AD_DOMAINS: ${{ steps.stats.outputs.ad_domains }}
          TRACKING_DOMAINS: ${{ steps.stats.outputs.tracking_domains }}
          MALICIOUS_DOMAINS: ${{ steps.stats.outputs.malicious_domains }}
          SUSPICIOUS_DOMAINS: ${{ steps.stats.outputs.suspicious_domains }}
          COMPREHENSIVE_DOMAINS: ${{ steps.stats.outputs.comprehensive_domains }}
          NSFW_DOMAINS: ${{ steps.stats.outputs.nsfw_domains }}
          UPDATE_DATE: ${{ steps.stats.outputs.update_date }}
        run: |
          # Update badge
          MILLION_FORMAT=$(echo "scale=1; $TOTAL_DOMAINS / 1000000" | bc | sed 's/^\./0./')
          sed -i "s#https://img.shields.io/badge/domains-[0-9.]*M%2B-blue#https://img.shields.io/badge/domains-${MILLION_FORMAT}M%2B-blue#g" README.md

          # Update last updated date
          sed -i "s#\*\*Last updated\*\*:.*#**Last updated**: $UPDATE_DATE#g" README.md

          # Update table domain counts using awk for reliability
          # Each row pattern: | **[file.txt](url)** | Description | NUMBER |
          awk -v all="$TOTAL_DOMAINS_FMT" \
              -v ad="$AD_DOMAINS" \
              -v track="$TRACKING_DOMAINS" \
              -v mal="$MALICIOUS_DOMAINS" \
              -v sus="$SUSPICIOUS_DOMAINS" \
              -v comp="$COMPREHENSIVE_DOMAINS" \
              -v nsfw="$NSFW_DOMAINS" '
          /\[all_domains\.txt\]/ { gsub(/[0-9,]+ \|$/, all " |") }
          /\[advertising\.txt\]/ { gsub(/[0-9,]+ \|$/, ad " |") }
          /\[tracking\.txt\]/ { gsub(/[0-9,]+ \|$/, track " |") }
          /\[malicious\.txt\]/ { gsub(/[0-9,]+ \|$/, mal " |") }
          /\[suspicious\.txt\]/ { gsub(/[0-9,]+ \|$/, sus " |") }
          /\[comprehensive\.txt\]/ { gsub(/[0-9,]+ \|$/, comp " |") }
          /\[nsfw\.txt\]/ { gsub(/[0-9,]+ \|$/, nsfw " |") }
          { print }
          ' README.md > README.md.tmp && mv README.md.tmp README.md

          echo "‚úÖ README updated"

      - name: Check for changes
        id: check_changes
        run: |
          mkdir -p lists

          FILES=("all_domains.txt" "advertising.txt" "tracking.txt" "malicious.txt" "suspicious.txt" "comprehensive.txt" "nsfw.txt")
          CHANGES_DETECTED=false
          CHANGED_FILES=""

          echo "üìã Checking for changes:"
          for file in "${FILES[@]}"; do
            if [ -f "pihole_blocklists_prod/$file" ]; then
              NEW_SIZE=$(du -h "pihole_blocklists_prod/$file" | cut -f1)

              if [ -f "lists/$file" ]; then
                if ! cmp -s "pihole_blocklists_prod/$file" "lists/$file"; then
                  OLD_SIZE=$(du -h "lists/$file" | cut -f1)
                  echo "  ‚úÖ $file changed ($OLD_SIZE ‚Üí $NEW_SIZE)"
                  CHANGES_DETECTED=true
                  CHANGED_FILES="$CHANGED_FILES $file"
                  cp "pihole_blocklists_prod/$file" "lists/$file"
                else
                  echo "  ‚ÑπÔ∏è $file unchanged ($NEW_SIZE)"
                fi
              else
                echo "  üÜï $file new ($NEW_SIZE)"
                CHANGES_DETECTED=true
                CHANGED_FILES="$CHANGED_FILES $file"
                cp "pihole_blocklists_prod/$file" "lists/$file"
              fi
            fi
          done

          echo "changes_detected=$CHANGES_DETECTED" >> $GITHUB_OUTPUT
          echo "changed_files=$CHANGED_FILES" >> $GITHUB_OUTPUT

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git remote set-url origin https://x-access-token:${{ secrets.GH_PAT }}@github.com/zachlagden/Pi-hole-Optimized-Blocklists.git

      - name: Commit and push
        if: steps.check_changes.outputs.changes_detected == 'true'
        run: |
          git add lists/*.txt README.md

          if git diff --staged --quiet; then
            echo "‚ÑπÔ∏è No changes to commit"
          else
            git commit -m "$(cat <<EOF
          Weekly blocklist update $(date +%F)

          - Total domains: ${{ steps.stats.outputs.total_domains_formatted }}
          - Duplicates removed: ${{ steps.stats.outputs.duplicates_formatted }}
          - Whitelist entries: ${{ steps.stats.outputs.whitelist_entries }}
          - Updated:${{ steps.check_changes.outputs.changed_files }}
          EOF
          )"

            git push
            echo "‚úÖ Changes pushed"
          fi

      - name: No changes
        if: steps.check_changes.outputs.changes_detected != 'true'
        run: echo "‚ÑπÔ∏è No changes detected"
